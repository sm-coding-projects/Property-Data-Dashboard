<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Property Sales Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .multi-select-container { position: relative; }
        .multi-select-dropdown { display: none; position: absolute; background-color: white; border: 1px solid #e2e8f0; border-radius: 0.375rem; width: 100%; z-index: 10; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .multi-select-dropdown.show { display: block; }
        .suburb-option { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
        .suburb-option:hover { background-color: #f9fafb; }
        .suburb-option:last-child { border-bottom: none; }
        .suburb-option.hidden { display: none; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #4f46e5; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        th.sortable::after { content: ' \25B2\25BC'; color: #ccc; }
        th.sorted-asc::after { content: ' \25B2'; color: #333; }
        th.sorted-desc::after { content: ' \25BC'; color: #333; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Main Container -->
    <div id="app" class="min-h-screen">
        
        <!-- Upload View -->
        <div id="uploadView" class="flex flex-col items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-lg bg-white p-8 rounded-xl shadow-lg text-center">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Property Sales Analysis Dashboard</h1>
                <p class="text-gray-600 mb-6">Upload a CSV file to begin your analysis.</p>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 hover:border-indigo-500 transition-colors">
                    <input type="file" id="csvFile" accept=".csv" class="hidden">
                    <label for="csvFile" id="fileLabel" class="cursor-pointer">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                        <span class="mt-2 block text-sm font-medium text-gray-900">Click to upload a file</span>
                        <span id="fileName" class="mt-1 block text-xs text-gray-500">CSV files only</span>
                    </label>
                </div>
                <button id="analyzeBtn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all" disabled>
                    Analyze Data
                </button>
                <!-- NEW: Progress Bar -->
                <div id="progressContainer" class="w-full mt-4 hidden">
                    <p id="progressText" class="text-sm text-gray-600 mb-1 text-left"></p>
                    <div class="w-full bg-gray-200 rounded-full">
                        <div id="progressBar" class="bg-indigo-600 text-xs font-medium text-indigo-100 text-center p-0.5 leading-none rounded-full transition-all duration-500" style="width: 0%">0%</div>
                    </div>
                </div>
            </div>
            <div id="errorMessage" class="mt-4 text-red-600 font-medium"></div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="hidden">
             <div class="flex flex-col lg:flex-row">
                <!-- Sidebar -->
                <aside class="w-full lg:w-80 bg-white p-6 border-r border-gray-200 lg:h-screen lg:sticky top-0 overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900">Filters</h2>
                        <button id="uploadNewBtn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Upload New</button>
                    </div>
                    
                    <!-- Suburb Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Suburb</label>
                        <div class="multi-select-container">
                            <button id="suburbSelectBtn" class="w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <span id="suburbSelectText" class="block truncate">Select suburbs...</span>
                            </button>
                            <div id="suburbDropdown" class="multi-select-dropdown mt-1">
                                <div class="p-2 border-b border-gray-200">
                                    <input type="text" id="suburbSearch" placeholder="Search suburbs..." class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 mb-2">
                                    <div class="flex gap-2">
                                        <button id="selectAllSuburbs" class="flex-1 px-2 py-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors">Select All</button>
                                        <button id="clearAllSuburbs" class="flex-1 px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">Clear All</button>
                                    </div>
                                </div>
                                <div id="suburbOptions" class="max-h-48 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Price Range Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Price Range</label>
                        <input type="range" id="minPrice" class="w-full mb-2">
                        <input type="range" id="maxPrice" class="w-full">
                        <div class="flex justify-between text-sm text-gray-600 mt-2">
                            <span id="minPriceLabel">$0</span>
                            <span id="maxPriceLabel">$5,000,000+</span>
                        </div>
                    </div>

                    <!-- Contract Date Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contract Date</label>
                        <div class="space-y-2">
                            <input type="date" id="startDate" class="w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <input type="date" id="endDate" class="w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>

                    <!-- Purpose Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Purpose</label>
                        <div class="multi-select-container">
                            <button id="purposeSelectBtn" class="w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <span id="purposeSelectText" class="block truncate">Select purposes...</span>
                            </button>
                            <div id="purposeDropdown" class="multi-select-dropdown mt-1">
                                <div class="p-2 border-b border-gray-200">
                                    <input type="text" id="purposeSearch" placeholder="Search purposes..." class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 mb-2">
                                    <div class="flex gap-2">
                                        <button id="selectAllPurposes" class="flex-1 px-2 py-1 text-xs bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors">Select All</button>
                                        <button id="clearAllPurposes" class="flex-1 px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">Clear All</button>
                                    </div>
                                </div>
                                <div id="purposeOptions" class="max-h-48 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Repeat Sales Filter -->
                    <div class="mb-6">
                        <div class="relative flex items-start">
                            <div class="flex items-center h-5"><input id="repeatSales" name="repeatSales" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"></div>
                            <div class="ml-3 text-sm"><label for="repeatSales" class="font-medium text-gray-700">Show properties sold > once</label></div>
                        </div>
                    </div>

                    <button id="resetFiltersBtn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-all">Reset Filters</button>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 p-6 lg:p-8 bg-gray-50">
                    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="loader"></div></div>
                    <!-- Key Metrics -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow"><h3 class="text-sm font-medium text-gray-500">Total Properties</h3><p id="totalProperties" class="mt-1 text-3xl font-semibold text-gray-900">0</p></div>
                        <div class="bg-white p-5 rounded-xl shadow"><h3 class="text-sm font-medium text-gray-500">Total Sales Value</h3><p id="totalSalesValue" class="mt-1 text-3xl font-semibold text-gray-900">$0</p></div>
                        <div class="bg-white p-5 rounded-xl shadow"><h3 class="text-sm font-medium text-gray-500">Average Price</h3><p id="avgPrice" class="mt-1 text-3xl font-semibold text-gray-900">$0</p></div>
                        <div class="bg-white p-5 rounded-xl shadow"><h3 class="text-sm font-medium text-gray-500">Median Price</h3><p id="medianPrice" class="mt-1 text-3xl font-semibold text-gray-900">$0</p></div>
                    </div>
                    <!-- Data Table -->
                    <div class="bg-white rounded-xl shadow overflow-hidden">
                        <div class="p-5 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <h3 class="text-lg font-semibold text-gray-900">Property Sales Data</h3>
                                <div class="flex items-center gap-2">
                                    <label for="rowsPerPageSelect" class="text-sm text-gray-600">Show:</label>
                                    <select id="rowsPerPageSelect" class="border border-gray-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="10">10</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                    </select>
                                    <span class="text-sm text-gray-600">per page</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button id="exportCsvBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-medium">
                                    Export CSV
                                </button>
                                <button id="exportPdfBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">
                                    Export PDF
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50"><tr id="tableHeaderRow"></tr></thead>
                                <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div id="paginationControls" class="p-4 flex items-center justify-between border-t border-gray-200"></div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
    // --- STATE MANAGEMENT ---
    let appState = {
        sessionId: null,
        filters: {
            suburbs: [],
            purposes: [],
            priceRange: [0, 0],
            dateRange: [null, null],
            repeatSales: false,
            sortColumn: 'Contract date',
            sortDirection: 'desc',
            page: 1,
            rowsPerPage: 10,
        },
        initialFilterValues: {},
        allSuburbs: [],
        allPurposes: [],
        totalRows: 0,
    };

    // --- DOM ELEMENTS ---
    const uploadView = document.getElementById('uploadView');
    const dashboardView = document.getElementById('dashboardView');
    const csvFileInput = document.getElementById('csvFile');
    const fileNameSpan = document.getElementById('fileName');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const errorMessage = document.getElementById('errorMessage');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const suburbSelectBtn = document.getElementById('suburbSelectBtn');
    const suburbSelectText = document.getElementById('suburbSelectText');
    const suburbDropdown = document.getElementById('suburbDropdown');
    const purposeSelectBtn = document.getElementById('purposeSelectBtn');
    const purposeSelectText = document.getElementById('purposeSelectText');
    const purposeDropdown = document.getElementById('purposeDropdown');
    const minPriceSlider = document.getElementById('minPrice');
    const maxPriceSlider = document.getElementById('maxPrice');
    const minPriceLabel = document.getElementById('minPriceLabel');
    const maxPriceLabel = document.getElementById('maxPriceLabel');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const repeatSalesCheckbox = document.getElementById('repeatSales');
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');
    const uploadNewBtn = document.getElementById('uploadNewBtn');
    const totalPropertiesEl = document.getElementById('totalProperties');
    const totalSalesValueEl = document.getElementById('totalSalesValue');
    const avgPriceEl = document.getElementById('avgPrice');
    const medianPriceEl = document.getElementById('medianPrice');
    const dataTableBody = document.getElementById('dataTableBody');
    const tableHeaderRow = document.getElementById('tableHeaderRow');
    const paginationControls = document.getElementById('paginationControls');
    const rowsPerPageSelect = document.getElementById('rowsPerPageSelect');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    // --- DEBOUNCE FUNCTION ---
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // --- EVENT LISTENERS ---
    csvFileInput.addEventListener('change', () => {
        if (csvFileInput.files.length > 0) {
            fileNameSpan.textContent = csvFileInput.files[0].name;
            analyzeBtn.disabled = false;
            errorMessage.textContent = '';
        }
    });

    analyzeBtn.addEventListener('click', handleDataUpload);
    uploadNewBtn.addEventListener('click', () => {
        location.reload(); // Simple way to reset the app
    });

    suburbSelectBtn.addEventListener('click', () => {
        suburbDropdown.classList.toggle('show');
        // Clear search and show all options when opening
        const suburbSearch = document.getElementById('suburbSearch');
        const suburbOptions = document.getElementById('suburbOptions');
        if (suburbSearch && suburbOptions) {
            suburbSearch.value = '';
            suburbOptions.querySelectorAll('.suburb-option').forEach(option => option.classList.remove('hidden'));
            // Focus on search input when dropdown opens
            setTimeout(() => suburbSearch.focus(), 100);
        }
    });

    purposeSelectBtn.addEventListener('click', () => {
        purposeDropdown.classList.toggle('show');
        // Clear search and show all options when opening
        const purposeSearch = document.getElementById('purposeSearch');
        const purposeOptions = document.getElementById('purposeOptions');
        if (purposeSearch && purposeOptions) {
            purposeSearch.value = '';
            purposeOptions.querySelectorAll('.purpose-option').forEach(option => option.classList.remove('hidden'));
            // Focus on search input when dropdown opens
            setTimeout(() => purposeSearch.focus(), 100);
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!suburbSelectBtn.contains(e.target) && !suburbDropdown.contains(e.target)) {
            suburbDropdown.classList.remove('show');
        }
        if (!purposeSelectBtn.contains(e.target) && !purposeDropdown.contains(e.target)) {
            purposeDropdown.classList.remove('show');
        }
    });

    const debouncedFetch = debounce(() => fetchFilteredData(), 500);
    minPriceSlider.addEventListener('input', () => {
        appState.filters.priceRange = [parseFloat(minPriceSlider.value), parseFloat(maxPriceSlider.value)];
        updatePriceSliderUI();
        debouncedFetch();
    });
    maxPriceSlider.addEventListener('input', () => {
        appState.filters.priceRange = [parseFloat(minPriceSlider.value), parseFloat(maxPriceSlider.value)];
        updatePriceSliderUI();
        debouncedFetch();
    });
    startDateInput.addEventListener('change', () => {
        appState.filters.dateRange[0] = startDateInput.value;
        fetchFilteredData();
    });
    endDateInput.addEventListener('change', () => {
        appState.filters.dateRange[1] = endDateInput.value;
        fetchFilteredData();
    });
    repeatSalesCheckbox.addEventListener('change', () => {
        appState.filters.repeatSales = repeatSalesCheckbox.checked;
        fetchFilteredData();
    });
    resetFiltersBtn.addEventListener('click', resetAllFilters);
    rowsPerPageSelect.addEventListener('change', () => {
        appState.filters.rowsPerPage = parseInt(rowsPerPageSelect.value);
        appState.filters.page = 1; // Reset to first page when changing page size
        fetchFilteredData();
    });

    // Export button event listeners
    document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
    document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);

    // --- FUNCTIONS ---
    async function checkSessionValidity() {
        if (!appState.sessionId) return false;
        
        try {
            const response = await fetch(`/api/session/${appState.sessionId}`);
            const result = await response.json();
            return result.valid;
        } catch (error) {
            console.error("Session check error:", error);
            return false;
        }
    }
    
    function handleDataUpload() {
        const file = csvFileInput.files[0];
        if (!file) return;

        // Reset UI
        errorMessage.textContent = '';
        analyzeBtn.disabled = true;
        progressContainer.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressText.textContent = 'Uploading...';
        progressBar.classList.remove('bg-yellow-500');
        progressBar.classList.add('bg-indigo-600');

        const formData = new FormData();
        formData.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/upload', true);

        // Track upload progress
        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percentComplete = Math.round((event.loaded / event.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
                if (percentComplete === 100) {
                    progressText.textContent = 'Upload complete. Analyzing data on server...';
                    progressBar.classList.remove('bg-indigo-600');
                    progressBar.classList.add('bg-yellow-500'); // Change color to indicate processing
                }
            }
        };

        // Handle completion
        xhr.onload = function() {
            analyzeBtn.disabled = false;
            progressContainer.classList.add('hidden');

            console.log('Upload response status:', xhr.status);
            console.log('Upload response text:', xhr.responseText);

            if (xhr.status >= 200 && xhr.status < 300) {
                const result = JSON.parse(xhr.responseText);
                console.log('Upload success result:', result);
                appState.sessionId = result.session_id;
                uploadView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                setupDashboard(result.filters);
                fetchFilteredData();
            } else {
                try {
                    const result = JSON.parse(xhr.responseText);
                    // Handle new error format
                    const errorMsg = result.error?.message || result.error || 'Failed to process file.';
                    errorMessage.textContent = `Error: ${errorMsg}`;
                } catch (e) {
                    errorMessage.textContent = `Error: Server returned status ${xhr.status}.`;
                }
            }
        };

        // Handle errors
        xhr.onerror = function() {
            analyzeBtn.disabled = false;
            progressContainer.classList.add('hidden');
            errorMessage.textContent = 'An error occurred during the upload. Please check your network connection.';
        };

        xhr.send(formData);
    }

    function setupDashboard(initialFilters) {
        appState.initialFilterValues = JSON.parse(JSON.stringify(initialFilters)); // Deep copy
        setupSuburbFilter(initialFilters.suburbs);
        setupPurposeFilter(initialFilters.purposes);
        setupPriceFilter(initialFilters.priceRange);
        setupDateFilter(initialFilters.dateRange);
        setupDataTableHeaders();
        resetAllFilters(false); // Set filters to initial state without fetching data
    }

    function setupSuburbFilter(suburbs) {
        // Store all suburbs for filtering
        appState.allSuburbs = suburbs;
        
        // Set up the dropdown structure
        const suburbOptions = document.getElementById('suburbOptions');
        const suburbSearch = document.getElementById('suburbSearch');
        
        // Clear existing options
        suburbOptions.innerHTML = '';
        
        // Create suburb options
        suburbs.forEach(suburb => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'suburb-option flex items-center';
            optionDiv.innerHTML = `<input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2" data-suburb="${suburb}"><span class="text-sm text-gray-800">${suburb}</span>`;
            optionDiv.dataset.suburb = suburb.toLowerCase(); // Store lowercase for searching
            
            optionDiv.querySelector('input').addEventListener('change', (e) => {
                const s = e.target.dataset.suburb;
                if (e.target.checked) {
                    appState.filters.suburbs.push(s);
                } else {
                    appState.filters.suburbs = appState.filters.suburbs.filter(sub => sub !== s);
                }
                updateSuburbButtonText();
                fetchFilteredData();
            });
            
            suburbOptions.appendChild(optionDiv);
        });
        
        // Add search functionality
        suburbSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const options = suburbOptions.querySelectorAll('.suburb-option');
            
            options.forEach(option => {
                const suburbName = option.dataset.suburb;
                if (suburbName.includes(searchTerm)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        });
        
        // Add keyboard support for search
        suburbSearch.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                suburbDropdown.classList.remove('show');
                suburbSelectBtn.focus();
            }
        });
        
        // Prevent dropdown from closing when clicking inside search input
        suburbSearch.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Add Select All functionality
        const selectAllBtn = document.getElementById('selectAllSuburbs');
        const clearAllBtn = document.getElementById('clearAllSuburbs');
        
        selectAllBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const visibleOptions = suburbOptions.querySelectorAll('.suburb-option:not(.hidden)');
            visibleOptions.forEach(option => {
                const checkbox = option.querySelector('input[type="checkbox"]');
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    const suburb = checkbox.dataset.suburb;
                    if (!appState.filters.suburbs.includes(suburb)) {
                        appState.filters.suburbs.push(suburb);
                    }
                }
            });
            updateSuburbButtonText();
            fetchFilteredData();
        });
        
        clearAllBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const visibleOptions = suburbOptions.querySelectorAll('.suburb-option:not(.hidden)');
            visibleOptions.forEach(option => {
                const checkbox = option.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const suburb = checkbox.dataset.suburb;
                    appState.filters.suburbs = appState.filters.suburbs.filter(s => s !== suburb);
                }
            });
            updateSuburbButtonText();
            fetchFilteredData();
        });
        
        // Prevent buttons from closing dropdown
        selectAllBtn.addEventListener('click', (e) => e.stopPropagation());
        clearAllBtn.addEventListener('click', (e) => e.stopPropagation());
        

    }

    function setupPurposeFilter(purposes) {
        // Store all purposes for filtering
        appState.allPurposes = purposes;
        
        // Set up the dropdown structure
        const purposeOptions = document.getElementById('purposeOptions');
        const purposeSearch = document.getElementById('purposeSearch');
        
        // Clear existing options
        purposeOptions.innerHTML = '';
        
        // Create purpose options
        purposes.forEach(purpose => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'purpose-option flex items-center';
            optionDiv.innerHTML = `<input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2" data-purpose="${purpose}"><span class="text-sm text-gray-800">${purpose}</span>`;
            optionDiv.dataset.purpose = purpose.toLowerCase(); // Store lowercase for searching
            
            optionDiv.querySelector('input').addEventListener('change', (e) => {
                const p = e.target.dataset.purpose;
                if (e.target.checked) {
                    appState.filters.purposes.push(p);
                } else {
                    appState.filters.purposes = appState.filters.purposes.filter(purpose => purpose !== p);
                }
                updatePurposeButtonText();
                fetchFilteredData();
            });
            
            purposeOptions.appendChild(optionDiv);
        });
        
        // Add search functionality
        purposeSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const options = purposeOptions.querySelectorAll('.purpose-option');
            
            options.forEach(option => {
                const purposeName = option.dataset.purpose;
                if (purposeName.includes(searchTerm)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        });
        
        // Add keyboard support for search
        purposeSearch.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                purposeDropdown.classList.remove('show');
                purposeSelectBtn.focus();
            }
        });
        
        // Prevent dropdown from closing when clicking inside search input
        purposeSearch.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Add Select All functionality
        const selectAllBtn = document.getElementById('selectAllPurposes');
        const clearAllBtn = document.getElementById('clearAllPurposes');
        
        selectAllBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const visibleOptions = purposeOptions.querySelectorAll('.purpose-option:not(.hidden)');
            visibleOptions.forEach(option => {
                const checkbox = option.querySelector('input[type="checkbox"]');
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    const purpose = checkbox.dataset.purpose;
                    if (!appState.filters.purposes.includes(purpose)) {
                        appState.filters.purposes.push(purpose);
                    }
                }
            });
            updatePurposeButtonText();
            fetchFilteredData();
        });
        
        clearAllBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const visibleOptions = purposeOptions.querySelectorAll('.purpose-option:not(.hidden)');
            visibleOptions.forEach(option => {
                const checkbox = option.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const purpose = checkbox.dataset.purpose;
                    appState.filters.purposes = appState.filters.purposes.filter(p => p !== purpose);
                }
            });
            updatePurposeButtonText();
            fetchFilteredData();
        });
        
        // Prevent buttons from closing dropdown
        selectAllBtn.addEventListener('click', (e) => e.stopPropagation());
        clearAllBtn.addEventListener('click', (e) => e.stopPropagation());
    }

    function setupPriceFilter(range) {
        const [min, max] = range;
        minPriceSlider.min = maxPriceSlider.min = min;
        minPriceSlider.max = maxPriceSlider.max = max;
    }

    function setupDateFilter(range) {
        const [min, max] = range;
        startDateInput.min = endDateInput.min = min;
        startDateInput.max = endDateInput.max = max;
    }


    
    function setupDataTableHeaders() {
        tableHeaderRow.innerHTML = '';
        const headers = {'Property': 'Property house number', 'Suburb': 'Property locality', 'Price': 'Purchase price', 'Contract Date': 'Contract date', 'Purpose': 'Primary purpose'};
        Object.entries(headers).forEach(([displayName, internalName]) => {
            const th = document.createElement('th');
            th.scope = 'col';
            th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable';
            th.textContent = displayName;
            th.dataset.sort = internalName;
            th.addEventListener('click', () => handleSort(internalName));
            tableHeaderRow.appendChild(th);
        });
    }

    function handleSort(column) {
        if (appState.filters.sortColumn === column) {
            appState.filters.sortDirection = appState.filters.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            appState.filters.sortColumn = column;
            appState.filters.sortDirection = 'asc';
        }
        fetchFilteredData();
    }

    async function fetchFilteredData() {
        // Check if we have a valid session ID
        if (!appState.sessionId) {
            dashboardView.classList.add('hidden');
            uploadView.classList.remove('hidden');
            errorMessage.textContent = 'Please upload a file to begin analysis.';
            return;
        }
        
        loadingOverlay.classList.remove('hidden');
        appState.filters.page = 1; // Reset to page 1 on any filter change
        try {
            const requestData = {
                ...appState.filters,
                session_id: appState.sessionId
            };
            const response = await fetch('/api/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error?.message || result.error);
            updateDashboard(result);
        } catch (error) {
            console.error("Filter error:", error);
            // Check if it's a session expiration error
            if (error.message.includes('Session not found') || error.message.includes('expired')) {
                // Reset to upload view
                dashboardView.classList.add('hidden');
                uploadView.classList.remove('hidden');
                appState.sessionId = null;
                errorMessage.textContent = 'Your session has expired. Please upload your file again.';
            } else {
                errorMessage.textContent = `Error: ${error.message}`;
            }
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }
    
    async function fetchPaginatedData(page) {
        // Check if we have a valid session ID
        if (!appState.sessionId) {
            dashboardView.classList.add('hidden');
            uploadView.classList.remove('hidden');
            errorMessage.textContent = 'Please upload a file to begin analysis.';
            return;
        }
        
        loadingOverlay.classList.remove('hidden');
        appState.filters.page = page;
        try {
            const requestData = {
                ...appState.filters,
                session_id: appState.sessionId
            };
            const response = await fetch('/api/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error?.message || result.error);
            updateDataTable(result.table);
            renderPaginationControls();
        } catch (error) {
            console.error("Pagination error:", error);
            // Check if it's a session expiration error
            if (error.message.includes('Session not found') || error.message.includes('expired')) {
                // Reset to upload view
                dashboardView.classList.add('hidden');
                uploadView.classList.remove('hidden');
                appState.sessionId = null;
                errorMessage.textContent = 'Your session has expired. Please upload your file again.';
            }
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    function updateDashboard(data) {
        updateMetrics(data.metrics);
        updateDataTable(data.table);
        updateHeaderSortIndicators();
        renderPaginationControls();
    }

    function updateMetrics(metrics) {
        totalPropertiesEl.textContent = metrics.totalProperties.toLocaleString();
        totalSalesValueEl.textContent = formatCurrency(metrics.totalSalesValue);
        avgPriceEl.textContent = formatCurrency(metrics.avgPrice);
        medianPriceEl.textContent = formatCurrency(metrics.medianPrice);
    }



    function updateDataTable(tableData) {
        appState.totalRows = tableData.totalRows;
        dataTableBody.innerHTML = '';
        if (tableData.data.length === 0) {
            dataTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">No data matches filters.</td></tr>`;
            return;
        }
        tableData.data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${row['Property house number'] || ''} ${row['Property street name'] || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row['Property locality']}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-medium">${formatCurrency(row['Purchase price'])}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row['Contract date']}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row['Primary purpose']}</td>
            `;
            dataTableBody.appendChild(tr);
        });
    }

    function resetAllFilters(fetch = true) {
        const initial = appState.initialFilterValues;
        appState.filters.suburbs = [];
        appState.filters.purposes = [];
        appState.filters.priceRange = initial.priceRange;
        appState.filters.dateRange = initial.dateRange;
        appState.filters.repeatSales = false;
        appState.filters.page = 1;
        appState.filters.rowsPerPage = 10;

        // Reset UI elements
        const suburbOptions = document.getElementById('suburbOptions');
        const suburbSearch = document.getElementById('suburbSearch');
        const purposeOptions = document.getElementById('purposeOptions');
        const purposeSearch = document.getElementById('purposeSearch');
        
        if (suburbOptions) {
            suburbOptions.querySelectorAll('input').forEach(i => i.checked = false);
            suburbOptions.querySelectorAll('.suburb-option').forEach(option => option.classList.remove('hidden'));
        }
        if (suburbSearch) {
            suburbSearch.value = '';
        }
        updateSuburbButtonText();
        
        if (purposeOptions) {
            purposeOptions.querySelectorAll('input').forEach(i => i.checked = false);
            purposeOptions.querySelectorAll('.purpose-option').forEach(option => option.classList.remove('hidden'));
        }
        if (purposeSearch) {
            purposeSearch.value = '';
        }
        updatePurposeButtonText();
        
        // FIX: Explicitly assign values to prevent potential errors
        minPriceSlider.value = initial.priceRange[0];
        maxPriceSlider.value = initial.priceRange[1];
        updatePriceSliderUI();

        startDateInput.value = initial.dateRange[0];
        endDateInput.value = initial.dateRange[1];
        repeatSalesCheckbox.checked = false;
        rowsPerPageSelect.value = '10';

        if (fetch) fetchFilteredData();
    }

    function updatePriceSliderUI() {
        let minVal = parseFloat(minPriceSlider.value);
        let maxVal = parseFloat(maxPriceSlider.value);

        // Fix: Prevent min from being greater than max
        if (minVal > maxVal) {
            if (minPriceSlider === document.activeElement) {
                // User is dragging min slider, adjust max
                maxPriceSlider.value = minVal;
                maxVal = minVal;
            } else {
                // User is dragging max slider, adjust min
                minPriceSlider.value = maxVal;
                minVal = maxVal;
            }
            appState.filters.priceRange = [minVal, maxVal];
        }
        
        minPriceLabel.textContent = formatCurrency(minVal);
        maxPriceLabel.textContent = formatCurrency(maxVal);
    }
    
    function updateSuburbButtonText() {
        const count = appState.filters.suburbs.length;
        if (count === 0) suburbSelectText.textContent = 'Select suburbs...';
        else if (count === 1) suburbSelectText.textContent = appState.filters.suburbs[0];
        else suburbSelectText.textContent = `${count} suburbs selected`;
    }
    
    function updatePurposeButtonText() {
        const count = appState.filters.purposes.length;
        if (count === 0) purposeSelectText.textContent = 'Select purposes...';
        else if (count === 1) purposeSelectText.textContent = appState.filters.purposes[0];
        else purposeSelectText.textContent = `${count} purposes selected`;
    }
    
    function updateHeaderSortIndicators() {
        document.querySelectorAll('#tableHeaderRow th').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
            if (th.dataset.sort === appState.filters.sortColumn) {
                th.classList.add(appState.filters.sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        });
    }

    function renderPaginationControls() {
        const rowsPerPage = appState.filters.rowsPerPage;
        const totalPages = Math.ceil(appState.totalRows / rowsPerPage);
        const currentPage = appState.filters.page;
        paginationControls.innerHTML = '';
        if (totalPages <= 1) return;

        const startItem = (currentPage - 1) * rowsPerPage + 1;
        const endItem = Math.min(currentPage * rowsPerPage, appState.totalRows);
        
        let html = `<p class="text-sm text-gray-700">Showing <span class="font-medium">${startItem}</span> to <span class="font-medium">${endItem}</span> of <span class="font-medium">${appState.totalRows}</span> results</p>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">`;
        html += `<button class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" ${currentPage === 1 ? 'disabled' : ''} onclick="fetchPaginatedData(${currentPage - 1})">&laquo;</button>`;
        // Simple pagination: show first, current-1, current, current+1, last
        let pagesToShow = [1, totalPages, currentPage, currentPage - 1, currentPage + 1];
        pagesToShow = [...new Set(pagesToShow)].filter(p => p > 0 && p <= totalPages).sort((a,b) => a-b);
        
        let lastPage = 0;
        for (const i of pagesToShow) {
            if (lastPage > 0 && i > lastPage + 1) {
                 html += `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>`;
            }
            if (i === currentPage) {
                html += `<button aria-current="page" class="z-10 bg-indigo-50 border-indigo-500 text-indigo-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">${i}</button>`;
            } else {
                html += `<button class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium" onclick="fetchPaginatedData(${i})">${i}</button>`;
            }
            lastPage = i;
        }

        html += `<button class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" ${currentPage === totalPages ? 'disabled' : ''} onclick="fetchPaginatedData(${currentPage + 1})">&raquo;</button></nav>`;
        paginationControls.innerHTML = html;nerHTML = html;
    }

    async function exportToCsv() {
        if (!appState.sessionId) {
            alert('Please upload a file first');
            return;
        }

        try {
            const requestData = {
                ...appState.filters,
                session_id: appState.sessionId,
                export_format: 'csv'
            };

            const response = await fetch('/api/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'property_sales_data.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                const error = await response.json();
                alert('Export failed: ' + (error.error?.message || error.error));
            }
        } catch (error) {
            console.error('Export error:', error);
            alert('Export failed: ' + error.message);
        }
    }

    async function exportToPdf() {
        if (!appState.sessionId) {
            alert('Please upload a file first');
            return;
        }

        try {
            const requestData = {
                ...appState.filters,
                session_id: appState.sessionId,
                export_format: 'pdf'
            };

            const response = await fetch('/api/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'property_sales_data.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                const error = await response.json();
                alert('Export failed: ' + (error.error?.message || error.error));
            }
        } catch (error) {
            console.error('Export error:', error);
            alert('Export failed: ' + error.message);
        }
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
    }
    
    // Initialize app on page load
    document.addEventListener('DOMContentLoaded', async function() {
        // Check if we're in dashboard view but don't have a valid session
        if (!dashboardView.classList.contains('hidden') && appState.sessionId) {
            const isValid = await checkSessionValidity();
            if (!isValid) {
                // Session expired, redirect to upload
                dashboardView.classList.add('hidden');
                uploadView.classList.remove('hidden');
                appState.sessionId = null;
                errorMessage.textContent = 'Your session has expired. Please upload your file again.';
            }
        }
        
        // Set up periodic session check (every 5 minutes)
        setInterval(async function() {
            if (appState.sessionId && !dashboardView.classList.contains('hidden')) {
                const isValid = await checkSessionValidity();
                if (!isValid) {
                    // Session expired, redirect to upload
                    dashboardView.classList.add('hidden');
                    uploadView.classList.remove('hidden');
                    appState.sessionId = null;
                    errorMessage.textContent = 'Your session has expired. Please upload your file again.';
                }
            }
        }, 5 * 60 * 1000); // 5 minutes
    });
    </script>
</body>
</html>
